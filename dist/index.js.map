{"version":3,"sources":["../src/Logger.ts","../src/utils.ts"],"sourcesContent":["import { init } from '@paralleldrive/cuid2';\nimport { createRootLogEntry, prettyError } from './utils';\nimport { LogData, LoggerOptions, LogEntry } from './types';\n\nexport class Logger {\n  public eventId: string;\n  private log: LogData;\n  public parentEventId?: string;\n\n  constructor(options: LoggerOptions) {\n    this.parentEventId = options.parentEventId;\n    this.eventId = init({ fingerprint: options.details.service })();\n\n    this.log = createRootLogEntry({\n      path: options.path || '/',\n      method: options.method,\n      details: options.details,\n      eventId: this.eventId,\n      parentEventId: options.parentEventId,\n      withParentEventId: options.withParentEventId,\n    });\n  }\n\n  // Area function that returns area-specific logger methods\n  public getArea(name = 'dummy') {\n    if (!this.log[name]) {\n      this.log[name] = [];\n    }\n\n    return {\n      info: (message: string, payload?: LogEntry['payload']) => {\n        this.log[name]!.push({\n          type: 'info',\n          message,\n          payload,\n          timestamp: Date.now(),\n        });\n      },\n      warn: (message: string, payload?: LogEntry['payload']) => {\n        this.log[name]!.push({\n          type: 'warn',\n          message,\n          payload,\n          timestamp: Date.now(),\n        });\n      },\n      error: (message: string, payload?: LogEntry['payload'] | Error) => {\n        this.log[name]!.push({\n          type: 'error',\n          message,\n          payload: payload instanceof Error ? prettyError(payload) : payload,\n          timestamp: Date.now(),\n        });\n      },\n    };\n  }\n\n  // Public methods on main instance\n  public dump(): LogData {\n    return this.log;\n  }\n\n  public appendLogData(logData: LogData): void {\n    delete logData.root;\n    this.log = { ...logData, ...this.log };\n  }\n}\n\n// Factory function for convenience\nexport const createLogger = (options: LoggerOptions): Logger => {\n  return new Logger(options);\n};\n","import { CreateRootLogEntryOptions, LogData, RootPayload } from './types';\n\nexport const prettyStack = (stack?: string): string[] => {\n  if (!stack) return [];\n  let toReplace = '';\n\n  const regex = /file:\\/\\/\\/(.*)(\\.wrangler|node_modules)\\/.*\\)/gm;\n  const m = regex.exec(stack);\n\n  if (m && m.length > 1) {\n    toReplace = m[1];\n  }\n\n  return stack\n    .split('\\n')\n    .map((line) => line.trim())\n    .filter((line) => !line.startsWith('Error: '))\n    .map((line) => line.replace(toReplace, ''))\n    .map((line) => line.replace('file://', ''));\n};\n\nexport const prettyError = (err: Error) => {\n  const stack = prettyStack(err.stack);\n  const message = err.message;\n  return { message, stack };\n};\n\nexport const createRootLogEntry = ({\n  path,\n  method,\n  details,\n  eventId,\n  parentEventId,\n  withParentEventId,\n}: CreateRootLogEntryOptions): LogData => {\n  const url = new URL(`http://example.com${path ?? '/'}`);\n\n  const rootLogEntry: LogData = {\n    root: [\n      {\n        type: 'info',\n        message: 'Request received',\n        payload: {\n          path: `${url.pathname}${url.search}`,\n          method,\n          details,\n          eventId,\n          ...(parentEventId && { parentEventId }),\n        } as RootPayload,\n        timestamp: Date.now(),\n      },\n    ],\n  };\n\n  if (withParentEventId && !parentEventId) {\n    rootLogEntry.root.push({\n      type: 'error',\n      message: 'Parent event ID expected but not found',\n      timestamp: Date.now(),\n    });\n  }\n\n  return rootLogEntry;\n};\n"],"mappings":"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","names":[]}